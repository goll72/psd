\documentclass[a4paper,12pt]{report}

\usepackage{float}

\usepackage[brazilian]{babel}
\usepackage[T1]{fontenc}

\usepackage{tikz}
\usetikzlibrary{calc,automata,positioning,arrows,shapes}

\usepackage[siunitx]{circuitikz}

\ctikzset{logic ports=ieee}

\title{RelatÃ³rio --- CPU}
\date{\today}

\begin{document}

\maketitle

\begin{figure}[H]
\begin{tikzpicture}[scale=0.8, every node/.style={transform shape}]
	\node[state, minimum size=2cm, initial] (reset) {RESET};
	\node[state, minimum size=2cm, right=of reset] (fetch) {FETCH};
	\node[state, minimum size=2cm, right=of fetch] (store) {STORE};

	\node[state, minimum size=2cm, above right=of store] (execute) {\footnotesize EXECUTE};
	\node[state, minimum size=2cm, right=of execute] (poll) {POLL};

	\node[state, minimum size=2cm, below right=of store] (fetch_imm) {\small \shortstack{FETCH\\IMM}};
	\node[state, minimum size=2cm, right=of fetch_imm] (store_imm) {\small \shortstack{STORE\\IMM}};

	\draw[->,thick] (reset) edge (fetch)
	          (fetch) edge (store)
	          (store) edge[bend left] (execute)
	          (store) edge[bend right] (fetch_imm)
	          (fetch_imm) edge (store_imm)
	          (store_imm) edge[bend right] (execute)
	          (execute) edge (poll)
	          (poll) edge[out=120,in=60,looseness=3] (poll)
	          (execute) edge[out=90,in=90,out looseness=1,in looseness=2] (fetch)
	          (poll) edge[out=315,in=270,distance=10cm] (fetch.south);
\end{tikzpicture}
\end{figure}

\begin{figure}[H]
\begin{circuitikz}[
	>=Triangle,
	square/.style={regular polygon,regular polygon sides=4},
	abstractic/.style={square,thick,draw,minimum size=2.5cm}
]

	\draw (3,4) node[abstractic] (io) {I/O};
	\draw (0,0) node[abstractic] (cpu) {CPU};
	\draw (6,0) node[abstractic] (mem) {MEM};

	\draw[<->,thick] ([yshift=1em]cpu.east) -- ([yshift=1em]mem.west);
	\draw[->,thick] ([yshift=-1em]cpu.east) -- ([yshift=-1em]mem.west);

	\path (cpu) -- (mem) node[midway] (mid) {};

	\draw[->,thick] ([yshift=1em]mid.center) to[short,*-] (io.south);

	\draw[scale=0.8,thick,transform shape] ([yshift=1.25em]cpu.east) ++ (0.2,0) to[multiwire=8] ([yshift=1.25em]mid.center);
\end{circuitikz}
\end{figure}

\begin{figure}[H]
\begin{circuitikz}[
	>=Triangle,
	scale=0.6,
	transform shape
]
	\tikzset{conn/.style={
		short,
		nodes width=0.07
	}}

	\tikzset{ic/.style={
		muxdemux,
		circuitikz/muxdemux/inner label font={},
		circuitikz/muxdemux/outer label font={},
		circuitikz/muxdemux/clock wedge size=0.5,
		circuitikz/muxdemux/inner label xsep=8pt,
		circuitikz/muxdemux/inner label ysep=6pt
	}}

	\tikzset{control_unit/.style={
		ic,
		muxdemux def={Lh=6.5,Rh=6.5,w=6.5,NL=5,NT=2,NB=0,NR=5},
		draw only left pins={2,4,5},
		draw only right pins={3,5},
		muxdemux label={L2=INT,L4=IR,L5=RS,T1=S,T2=Z,R3=CTL,R5=SEL}
	}}

	\tikzset{reg_file/.style={
		ic,
		muxdemux def={Lh=7.5,Rh=7.5,w=7,NL=5,NT=0,NB=0,NR=2},
		muxdemux label={L1=D,L2=SEL,L3=$\textrm{SEL}_A$,L4=$\textrm{SEL}_B$,L5=$\textrm{WR}_{EN}$,R1=A,R2=B},
	}}

	\tikzset{alu/.style={
		ic,
		muxdemux def={Lh=6.5,Rh=3,NL=2,NR=1,NT=1,NB=2,w=3,inset w=0.75,inset Lh=1,inset Rh=0},
		muxdemux label={T1=OP,B1=O,B2=C}
	}}

	\tikzset{reg/.style={
		flipflop,
		flipflop def={t1=D,t3=$\textrm{WR}_{EN}$,t6=Q}
	}}

	\coordinate (left_offset_near) at ($(-1,0)$);
	\coordinate (left_offset_far) at ($(-1.5,0)$);

	% signals
	\draw (2,18) node[signal,draw,signal to=east,anchor=east] (int) {\footnotesize INT};
	\draw (2,17) node[signal,draw,signal to=east,anchor=east] (data_bus) {\footnotesize DATA\_BUS};
	\draw (21,-5) node[signal,draw,signal to=west] (addr_bus) {\footnotesize ADDR\_BUS};

	% control unit and register file
	\draw (4, 14) node[adder] (pc_adder) {};
	\draw (10,10) node[control_unit] (cu) {};
	\draw (8,1) node[reg_file,label={[label distance=8pt]south:REGISTER FILE}] (regs) {};

	\coordinate (alu_xpos) at ($(regs.center) + (4,0)$);
	\draw (regs.rpin 1 -| alu_xpos) node[alu,anchor=lpin 1] (alu) {};

	% register connections
	\draw (regs.rpin 1) edge (alu.lpin 1)
	      (regs.rpin 2) edge (alu.lpin 2);

	% registers
	\coordinate (pc_ir_rs_start) at (1,10);
	\coordinate (reg_offset) at (0,-4);

	\draw (pc_ir_rs_start) node[reg,label={[label distance=6pt]south:PC}] (pc) {};
	\draw ($(pc_ir_rs_start) + 1*(reg_offset)$) node[reg,label={[label distance=6pt]south:IR}] (ir) {};
	\draw ($(pc_ir_rs_start) + 2*(reg_offset)$) node[reg,label={[label distance=6pt]south:RS}] (rs) {};

	\coordinate (zsco_start) at (21,14);

	\draw (zsco_start) node[reg,label={[label distance=6pt]south:Z}] (z) {};
	\draw ($(zsco_start) + 1*(reg_offset)$) node[reg,label={[label distance=6pt]south:S}] (s) {};
	\draw ($(zsco_start) + 2*(reg_offset)$) node[reg,label={[label distance=6pt]south:C}] (c) {};
	\draw ($(zsco_start) + 3*(reg_offset)$) node[reg,label={[label distance=6pt]south:O}] (o) {};

	% pc adder connections
	\coordinate (pc_adder_out_xpos) at ($(pc.center) + (-2.5,0)$);
	\draw (pc.pin 6) -- (pc.pin 6 -| pc_adder.south);
	\draw[->] (pc_adder.south |- pc.pin 6) -- (pc_adder.south); 

	\node at ([yshift=4em]pc_adder.north) (pc_adder_const_one) {1};
	\draw[->] ([yshift=3em]pc_adder.north) -- (pc_adder.north);
	\draw (pc_adder.west) -- (pc_adder.west -| pc_adder_out_xpos);

	\draw ($(pc_adder.west -| pc_adder_out_xpos)!0.5!(pc_adder_out_xpos |- pc.pin 1)$) 
	      node[buffer port,scale=0.8,anchor=center,rotate=270] (next_pc_tristate) {};

	\draw (pc_adder.west -| pc_adder_out_xpos) -- (next_pc_tristate.in 1);
	\draw (next_pc_tristate.out) -- (pc_adder_out_xpos |- pc.pin 1);
	\draw (pc_adder_out_xpos |- pc.pin 1) to[conn,*-] (pc.pin 1);

	\draw (next_pc_tristate.up) -- ($(next_pc_tristate.up) + (0.3,0)$) 
	      node[signal,draw,signal to=west,anchor=west] {\footnotesize CTL\_INCREMENT\_PC};

	% int signal to control unit
	\coordinate (cu_int_offset) at ($(cu.lpin 2) + (left_offset_near)$);
	\draw (int.east) -- (int.east -| cu_int_offset) -- (cu_int_offset |- cu.lpin 2) -- (cu.lpin 2);

	% ir to control unit
	\draw (ir.pin 6) -- (ir.pin 6 -| alu.tpin 1) -- (alu.tpin 1);
	\coordinate (cu_ir_offset) at ($(cu.lpin 4) + (left_offset_near)$);
	\draw (cu.lpin 4) -- (cu_ir_offset) to[conn,-*] (cu_ir_offset |- ir.pin 6);

	% rs connections

	% pc output connections
	\draw (pc.pin 6 -| pc_adder.south) to[conn,*-] (pc_adder.south |- addr_bus);

	\draw ($(pc_adder.south |- addr_bus)!0.2!(addr_bus.west)$) 
	      node[buffer port,scale=0.8,anchor=center] (pc_addr_tristate) {};

	\draw (pc_adder.south |- addr_bus) -- (pc_addr_tristate.in 1);
	\draw (pc_addr_tristate.out) -- (addr_bus.west);

	\coordinate (pc_addr_signal_pos) at ($(pc_addr_tristate.center) + (-0.5,-0.9)$);

	\draw (pc_addr_tristate.down) -- (pc_addr_tristate.down |- pc_addr_signal_pos) -- (pc_addr_signal_pos) 
	      node[signal,draw,signal to=east,anchor=east] {\footnotesize CTL\_PC\_TO\_ADDR};

	% register file b output to addr
	\coordinate (reg_b_addr_out) at ($(regs.rpin 2)!0.7!(alu.lpin 2)$);

	\draw ($(reg_b_addr_out)!0.8!(reg_b_addr_out |- addr_bus)$) node[buffer port,scale=0.8,rotate=270] (reg_b_addr_tristate) {};

	\draw (reg_b_addr_out) to[conn,*-] (reg_b_addr_out |- reg_b_addr_tristate.in 1);
	\draw (reg_b_addr_tristate.out) to[conn,-*] (reg_b_addr_out |- addr_bus);

	\draw (reg_b_addr_tristate.up) -- ($(reg_b_addr_tristate.up) + (0.75,0)$);
	\draw ($(reg_b_addr_tristate.up) + (0.75,0)$) node[signal,draw,signal to=west,anchor=west] {\footnotesize CTL\_REG\_B\_TO\_ADDR};

	% register file b output to pc
	\coordinate (reg_b_pc_out) at ($(reg_b_addr_out)!0.8!(reg_b_addr_out |- reg_b_addr_tristate.in 1)$);

	\draw ($(reg_b_pc_out)!0.8!(pc_adder_out_xpos |- reg_b_pc_out)$)
	      node[buffer port,scale=0.8,rotate=180] (reg_b_pc_tristate) {};

	\coordinate (reg_b_pc_signal_pos) at ($(reg_b_pc_tristate) + (-0.5,-0.85)$);

	\draw (reg_b_pc_tristate.up) -- (reg_b_pc_tristate.up |- reg_b_pc_signal_pos) -- (reg_b_pc_signal_pos)
	      node[signal,draw,signal to=east,anchor=east] {\footnotesize CTL\_REG\_B\_TO\_PC};

	\draw (reg_b_pc_out) to[conn,*-] (reg_b_pc_tristate.in 1);
	\draw (reg_b_pc_tristate.out) -- (reg_b_pc_tristate.out -| pc_adder_out_xpos) -- (pc_adder_out_xpos |- pc.pin 1);

	% register file b output to register file data in

	% carry, overflow register outputs
	\draw (c.pin 6) -- ($(c.pin 6) + (0.5,0)$) node[plain crossing,scale=1.2,rotate=45] {};
	\draw (o.pin 6) -- ($(o.pin 6) + (0.5,0)$) node[plain crossing,scale=1.2,rotate=45] {};
\end{circuitikz}
\end{figure}

\end{document}
